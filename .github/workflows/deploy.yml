name: Deploy KS Foundation Platform

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    # 1. BUILD FRONTEND
    - name: Use Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18'

    - name: Build React (Vite)
      run: |
        cd frontend
        npm install
        # Injecting environment variables for the build
        VITE_API_URL=${{ secrets.VITE_API_URL }} VITE_RECAPTCHA_SITE_KEY=${{ secrets.VITE_RECAPTCHA_SITE_KEY }} npm run build

    # 2. COPY FILES TO VPS
    - name: Copy files via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_IP }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        # Copy backend source and frontend build output (dist)
        source: "backend,frontend/dist"
        target: "/var/www/ks-foundation"

    # 3. CONFIGURE BACKEND & SERVE SITE
    - name: Execute Remote SSH Commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_IP }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        
        script: |
          # 1. Backend Setup
          cd /var/www/ks-foundation/backend/
          
          # Inject production env file
          echo "${{ secrets.PROD_ENV_FILE }}" > .env
          
          # Virtual Environment
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          source venv/bin/activate
          
          # Install dependencies
          pip install -r requirements.txt

          # Database Migrations & Static Files
          python manage.py migrate
          python manage.py collectstatic --noinput

          # Restart Gunicorn Service (Backend)
          sudo systemctl restart ksf_backend
